#!/bin/bash --rcfile
# Copyright 2017 Queue Continuum LLC

venv_update () {
	if [ ! -f "$DIR/.venv/.requirements.txt.d" -o "$DIR/requirements.txt" -nt "$DIR/.venv/.requirements.txt.d" ]
	then
		virtualenv --clear "$DIR/.venv"
		pip install -r "$DIR/requirements.txt"
		touch "$DIR/.venv/.requirements.txt.d"
	fi
	return 0
}

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ -f ~/.bashrc ]
then
	. ~/.bashrc
fi
# TODO on Debian, /etc/bash.bashrc is sourced as well

if [ -z ${PATH+x} ]
then
	export PATH="$DIR/bin"
else
	export PATH="$DIR/bin:$PATH"
fi

if [ -z ${PYTHONPATH+x} ]
then
	export PYTHONPATH="$DIR/lib/python2.7"
else
	export PYTHONPATH="$DIR/lib/python2.7:$PYTHONPATH"
fi

if [ ! -d "$DIR/.venv" ]
then
	virtualenv "$DIR/.venv"
fi

VENV_OLD_PS1="$PS1"

. "$DIR/.venv/bin/activate"

if [ ! "$VIRTUAL_ENV" -ef "$DIR/.venv" ]
then
	echo "Unexpected Python virtual environment."
	exit 1
fi

venv_update

if [ -f "$DIR/.venvrc" ]
then
	. "$DIR/.venvrc"
fi

if [ -z ${VENV_NAME+x} ]
then
	VENV_NAME="$DIR"
fi

PS1="($VENV_NAME) $VENV_OLD_PS1"
